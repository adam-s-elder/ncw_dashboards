---
title: "clean_acs_data"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Package Management

Ensure all required packages are installed 

```{r package-management, message=FALSE, warning=FALSE}
required_packages <- c("here", "tidyverse")

install_if_missing <- function(package) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
  }
}

lapply(required_packages, install_if_missing)
```

# Load Libraries
Load the required libraries. 


```{r}
library(tidyverse)
library(here)
```

# Cleaning

Read and clean the data.

```{r}
# Reading in ACS data

percent of civilian non-institutionalized individuals that have a disability

library(tidycensus)

data_opts_5 <- tidycensus::load_variables(2021, dataset = "acs5")
data_opts_1 <- tidycensus::load_variables(2021, dataset = "acs1")

# Insurance
# There are no overall counts so summing over disaggregated counts
# is needed here unfortunately.

insurance_vars <-
  c("B27010_002" = "under_19_total", "B27010_017" = "under_19_no_insurance",
    "B27010_018" = "19_35_total", "B27010_033" = "19_35_no_insurance",
    "B27010_034" = "35_64_total", "B27010_050" = "35_64_no_insurance",
    "B27010_051" = "65_plus_total", "B27010_066" = "65_plus_no_insurance")

ins_tidy <- get_acs(geography = "county", variables = names(insurance_vars),
                    state = "WA",  year = 2022)

ins_tidy <- ins_tidy |>
  left_join(data.frame(variable = names(insurance_vars),
                       named_var = insurance_vars), by = "variable")
ins_tidy$age_group <- str_extract_all(ins_tidy$named_var, "\\d+\\.?\\d*") |>
  purrr::map(paste0, collapse = "-") |> do.call(what = c)
ins_tidy$insr_group <- c("uninsured", "total")[
  1 + as.numeric(grepl(ins_tidy$named_var, pattern = "total"))
]

uninsured <- ins_tidy |> select(NAME, estimate, age_group, insr_group) |>
  pivot_wider(id_cols = c("NAME", "age_group"),
              names_from = insr_group, values_from = estimate) |>
  group_by(NAME) |> summarise(
    "perc_uninsured" = 100 * (sum(uninsured) / sum(total)),
    "population" = sum(total)
  )

foodstamps_vars <- c("B22010_001" = "total", "B22010_002" = "foodstamps")

fs_tidy <- get_acs(geography = "county", variables = names(foodstamps_vars),
                    state = "WA",  year = 2022) |>
  left_join(data.frame(variable = names(foodstamps_vars),
                       named_var = foodstamps_vars), by = "variable")

foodstamps <- fs_tidy |> select(NAME, estimate, named_var) |>
  pivot_wider(id_cols = c("NAME"),
              names_from = named_var, values_from = estimate) |>
  group_by(NAME) |> summarise(
    "perc_foodstamps" = 100 * (foodstamps / total),
    "population" = total
  )

poor_vars <- c("B16009_001" = "total", "B16009_002" = "poor")

poor_tidy <- get_acs(geography = "county", variables = names(poor_vars),
                   state = "WA",  year = 2022) |>
  left_join(data.frame(variable = names(poor_vars),
                       named_var = poor_vars), by = "variable")

poverty_df <- poor_tidy |> select(NAME, estimate, named_var) |>
  pivot_wider(id_cols = c("NAME"),
              names_from = named_var, values_from = estimate) |>
  group_by(NAME) |> summarise(
    "perc_below_poverty_line" = 100 * (poor / total), "population" = total)


disability_vars <-
  c("C18120_003" = "emp_lf_total", "C18120_004" = "emp_lf_w_disability",
    "C18120_006" = "unemp_lf_total", "C18120_007" = "unemp_lf_w_disability",
    "C18120_009" = "non_lf_total", "C18120_010" = "non_lf_w_disability")

disab_tidy <- get_acs(geography = "county",
                      variables = names(disability_vars),
                      state = "WA",  year = 2022)

disab_tidy <- disab_tidy |>
  left_join(data.frame(variable = names(disability_vars),
                       named_var = disability_vars), by = "variable")
disab_tidy$empl_status <-
  str_replace(disab_tidy$named_var, "_w_disability|_total", "")
disab_tidy$disab_status <-
  str_replace(disab_tidy$named_var,
              paste0(unique(disab_tidy$empl_status),
                     collapse = "|"), "") |> str_replace("_", "")

disability <- disab_tidy |> select(NAME, estimate, empl_status, disab_status) |>
  pivot_wider(id_cols = c("NAME", "empl_status"),
              names_from = disab_status, values_from = estimate) |>
  group_by(NAME) |> summarise(
    "perc_w_disability" = 100 * (sum(w_disability) / sum(total)),
    "population" = sum(total)
  )
```

# Write Clean Data

Write the cleaned data csv file.

```{r}
#TODO: ADAM Add code to combine across all counties for state level estimates 
# and also create an NCW level estimate.

```

